name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout homebrew tap
      uses: actions/checkout@v4
      with:
        repository: yigitkonur/homebrew-context
        token: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
        path: homebrew-tap

    - name: Update formula version and SHA
      run: |
        cd homebrew-tap
        
        # Get the release tag (e.g., v3.1.0)
        VERSION="${{ github.ref_name }}"
        VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix for version number
        
        # Download the release tarball and calculate SHA256
        TARBALL_URL="https://github.com/yigitkonur/code-to-clipboard-for-llms/archive/refs/tags/${VERSION}.tar.gz"
        SHA256=$(curl -sL "$TARBALL_URL" | shasum -a 256 | cut -d ' ' -f 1)
        
        echo "Version: $VERSION_NUM"
        echo "SHA256: $SHA256"
        
        # Update only the main formula URL, SHA, and version (not resources)
        # Use line-specific updates to avoid touching resource blocks
        sed -i "6s|url \".*\"|url \"$TARBALL_URL\"|" Formula/context.rb
        sed -i "7s|sha256 \".*\"|sha256 \"$SHA256\"|" Formula/context.rb
        sed -i "9s|version \".*\"|version \"$VERSION_NUM\"|" Formula/context.rb
        
        cat Formula/context.rb

    - name: Commit and push changes
      run: |
        cd homebrew-tap
        git config user.name "yigitkonur"
        git config user.email "9989650+yigitkonur@users.noreply.github.com"
        git add Formula/context.rb
        git diff --staged --quiet || git commit -m "Update context to ${{ github.ref_name }}"
        git push

    - name: Verify Homebrew formula update
      run: |
        echo "Waiting for formula update to propagate..."
        sleep 10
        echo "Checking if formula was updated..."
        curl -sf "https://raw.githubusercontent.com/yigitkonur/homebrew-context/main/Formula/context.rb" | head -20