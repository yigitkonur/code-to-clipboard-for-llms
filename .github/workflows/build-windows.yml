name: Build Windows Executable

on:
  release:
    types: [published]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pyperclip gitignore-parser
    
    - name: Build executable with PyInstaller
      run: |
        pyinstaller --onefile --name context --clean llmcontext.py
    
    - name: Calculate SHA256
      id: sha
      shell: pwsh
      run: |
        $hash = (Get-FileHash -Algorithm SHA256 dist/context.exe).Hash.ToLower()
        echo "sha256=$hash" >> $env:GITHUB_OUTPUT
        echo "SHA256: $hash"
    
    - name: Upload executable to release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/context.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Output release info
      run: |
        echo "Version: ${{ github.ref_name }}"
        echo "SHA256: ${{ steps.sha.outputs.sha256 }}"
        echo "Download URL: https://github.com/yigitkonur/code-to-clipboard-for-llms/releases/download/${{ github.ref_name }}/context.exe"

  update-scoop-bucket:
    needs: build-windows
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for release asset to be available
      run: sleep 30
    
    - name: Download and calculate SHA256
      id: sha
      run: |
        VERSION="${{ github.ref_name }}"
        URL="https://github.com/yigitkonur/code-to-clipboard-for-llms/releases/download/${VERSION}/context.exe"
        echo "Downloading from: $URL"
        
        # Wait and retry for the asset to be available
        for i in {1..5}; do
          if curl -sLf -o context.exe "$URL"; then
            echo "Download successful"
            break
          fi
          echo "Attempt $i failed, waiting..."
          sleep 10
        done
        
        SHA256=$(sha256sum context.exe | cut -d ' ' -f 1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "SHA256: $SHA256"
    
    - name: Checkout Scoop bucket
      uses: actions/checkout@v4
      with:
        repository: yigitkonur/scoop-context
        token: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
        path: scoop-bucket
    
    - name: Update Scoop manifest
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION_NUM="${VERSION#v}"
        SHA256="${{ steps.sha.outputs.sha256 }}"
        
        mkdir -p scoop-bucket/bucket
        
        cat > scoop-bucket/bucket/context.json << EOF
        {
            "version": "${VERSION_NUM}",
            "description": "The ultimate context packer for your AI coding assistant. Scans your repo and bundles code into clipboard-ready prompts for LLMs.",
            "homepage": "https://github.com/yigitkonur/code-to-clipboard-for-llms",
            "license": "MIT",
            "url": "https://github.com/yigitkonur/code-to-clipboard-for-llms/releases/download/${VERSION}/context.exe",
            "hash": "${SHA256}",
            "bin": "context.exe",
            "checkver": {
                "github": "https://github.com/yigitkonur/code-to-clipboard-for-llms"
            },
            "autoupdate": {
                "url": "https://github.com/yigitkonur/code-to-clipboard-for-llms/releases/download/v\$version/context.exe"
            }
        }
        EOF
        
        echo "Generated manifest:"
        cat scoop-bucket/bucket/context.json
    
    - name: Commit and push Scoop bucket
      run: |
        cd scoop-bucket
        git config user.name "yigitkonur"
        git config user.email "9989650+yigitkonur@users.noreply.github.com"
        git add -A
        git diff --staged --quiet || git commit -m "Update context to ${{ github.ref_name }}"
        git push origin main
      env:
        GITHUB_TOKEN: ${{ secrets.HOMEBREW_GITHUB_TOKEN }}
